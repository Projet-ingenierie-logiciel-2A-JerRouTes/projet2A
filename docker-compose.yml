# Note : La ligne 'version' est supprimée pour éviter le Warning Docker Compose V2.

services:
  # ============================================================================
  # SERVICE : BASE DE DONNÉES (Le socle de stockage)
  # ============================================================================
  db:
    # Utilisation d'une version stable de PostgreSQL
    image: postgres:16
    container_name: projet2a_postgres
    # Redémarre automatiquement le conteneur si le PC redémarre ou si le service crash
    restart: always
    
    # Configuration des variables d'environnement (Identifiants de connexion)
    environment:
      - POSTGRES_DB=${POSTGRES_DATABASE} # image officielle Postgres EXIGE ce nom exact pour créer la BDD
      - POSTGRES_USER
      - POSTGRES_PASSWORD

    # Expose le port de la base pour pouvoir y accéder depuis un outil comme DBeaver
    ports:
      - "5432:5432"
    
    volumes:
      # PERSISTANCE : Lie un volume Docker au dossier de données de Postgres.
      # Même après un 'docker compose down', les stocks d'Alice et Bob restent sauvés.
      - projet2a_pgdata:/var/lib/postgresql/data
      
      # INITIALISATION : Chaque fichier .sql dans ./data est exécuté au PREMIER lancement.
      # Indispensable pour créer vos tables et insérer vos données de test automatiquement.
      - ./data:/docker-entrypoint-initdb.d/
    
    # ISOLATION & SÉCURITÉ : On s'assure que Postgres répond avant de lancer le reste.
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U projet_user -d projet2a"]
      interval: 5s   # Teste toutes les 5 secondes
      timeout: 5s    # Attend 5 secondes max pour une réponse
      retries: 10    # Réessaie 10 fois avant de déclarer le service "unhealthy"

  # ============================================================================
  # SERVICE : BACKEND (L'intelligence en Python FastAPI)
  # ============================================================================
  backend:
    # Docker va chercher le 'Dockerfile' dans le dossier spécifié
    build: ./src/backend
    container_name: projet2a_backend
    restart: always
    
    volumes:
      # MODE DÉVELOPPEMENT : Lie votre code source au dossier /app du conteneur.
      # Permet de voir vos modifs de code en temps réel sans tout reconstruire.
      #- ./src/backend:/app
      - ./src:/app/src

    
    ports:
      - "8000:8000"
    
    environment:
      # On utilise le nom du service 'db' comme nom d'hôte (Network Docker).
      #DATABASE_URL: postgresql://projet_user:projet_pwd@db:5432/projet2a
      #PYTHONPATH: /app
      # Docker pioche ces valeurs directement dans ton .env
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_DATABASE
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_SCHEMA
      - PYTHONPATH=/app
    
    # ORCHESTRATION : Le backend ne démarre QUE quand la DB est déclarée "healthy".
    depends_on:
      db:
        condition: service_healthy

  # ============================================================================
  # SERVICE : FRONTEND (L'interface en React + Vite)
  # ============================================================================
  frontend:
    build: ./src/frontend
    container_name: projet2a_frontend
    restart: always
    
    volumes:
      # Synchronisation du code pour le Hot Reload de Vite
      - ./src/frontend:/app
      # Évite que le volume n'écrase les node_modules installés lors du build
      - /app/node_modules
    
    ports:
      - "5173:5173"
    
    # Le front dépend du backend pour fonctionner correctement
    depends_on:
      - backend

# ==============================================================================
# SECTION VOLUMES : Déclaration du stockage nommé
# ==============================================================================
volumes:
  # Ce volume est géré par Docker et persiste en dehors du cycle de vie des conteneurs.
  projet2a_pgdata: